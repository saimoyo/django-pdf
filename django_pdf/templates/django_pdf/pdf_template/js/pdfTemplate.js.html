{% include "django_pdf/js/template.js.html" %}

<script>
    {% verbatim %}
        const FIND_VARIABLES_REGEX = /{{(.*?)}}/g;
    {% endverbatim %}

    function pdfTemplateCtx (){
        return {
            ...baseTemplateCtx(),
            variableName: "",
            templateFilePath: "",
            templateFileName: "",
            get variableNameClass() {
                if (this.contextSchema.hasOwnProperty(this.variableName)){
                    return "p-1 border border-danger flex-fill me-1"
                }
                return "p-1 flex-fill me-1"
            },
            addContextVariable(){
                const variableName = this.variableName
                this.variableName = ""
                if (!this.contextSchema.hasOwnProperty(variableName)) {
                    this.contextSchema[variableName] = {
                        required: false,
                        font_family: "Arial, Helvetica, sans-serif",
                        font_size_px: 16,
                        x_pos: 0,
                        y_pos: 0,
                        x_px: 0,
                        y_px: 0,
                        show_example: false,
                    }
                    this.exampleContext[variableName] = "Hello World"
                }
            },
            getAnnotateVariableStyle(variableName){
                const variableSchema = this.contextSchema[variableName]
                return {
                    'font-family': variableSchema.font_family,
                    'font-size': (variableSchema.font_size_px + 'px'),
                    'left': `${variableSchema.x_pos}px`,
                    'top': `${variableSchema.y_pos}px`,
                    'width': 'fit-content',
                }
            },
            getAnnotateVariableExample(variableName){
                if (this.contextSchema[variableName].show_example){
                    return exampleContext[variableName]
                }
                return variableName
            },
            removeContextVariable(variableName) {
                if (this.contextSchema.hasOwnProperty(variableName)) {
                    const newContextSchema = {...this.contextSchema}
                    delete newContextSchema[variableName]
                    this.contextSchema = newContextSchema
                }
                if (this.exampleContext.hasOwnProperty(variableName)) {
                    const newExampleContext = {...this.exampleContext}
                    delete newExampleContext[variableName]
                    this.exampleContext = newExampleContext
                }
            },
            saveData() {
                const form = document.getElementById('templateForm');
                if (form.reportValidity()) {
                    this.setInputValue('context_schema', this.contextSchema)
                    this.setInputValue('example_context', this.exampleContext)
                    form.submit()
                }
            },
            setOnMove(element, variableName){
                interact(element)
                    .draggable({
                        onmove: (event) => {
                            const schema = this.contextSchema[variableName]
                            const element = document.getElementById(variableName)
                            const x_pos = schema.x_pos + event.dx;
                            const y_pos = schema.y_pos + event.dy;
                            schema.x_px = (
                                (x_pos)
                                /this.pdfFileDetails.totalWidthPX
                            )
                            const abs_y_pos = y_pos+element.clientHeight
                            const margin = Math.floor((abs_y_pos/this.pdfFileDetails.totalHeightPX)) * 20
                            schema.y_px = (
                                (abs_y_pos-margin)
                                /this.pdfFileDetails.totalHeightPX
                            )
                            schema.x_pos = x_pos
                            schema.y_pos = y_pos
                            console.log(schema)
                        },
                    })
            },
            getSetTemplateFileFunc(){
                const onCompleteFuncCtx = this
                function setTemplateFile(pdfDoc, pdfUrl){
                    const blob = new Blob([pdfDoc.data], { type: 'application/pdf' });
                    const fileName = onCompleteFuncCtx.getFilenameFromUrl(pdfUrl)
                    const file = new File(
                        [blob],
                        fileName,
                        { type: 'application/pdf', lastModified: Date.now() }
                    );
                    onCompleteFuncCtx.templateFileName = fileName
                    const templateFileElement = document.getElementById("template_file")
                    const dataTransfer = new DataTransfer()
                    dataTransfer.items.add(file)
                    templateFileElement.files = dataTransfer.files
                }
                return setTemplateFile
            },
            getFilenameFromUrl(url) {
                // Split the URL into segments
                const segments = url.split('/');

                // Get the last segment, which should be the filename
                let filename = segments.pop();

                // If the URL had a trailing slash, pop again to get the filename
                while (filename === '') {
                    filename = segments.pop();
                }

                // If the filename has a query string or hash fragment, split by '?' or '#'
                return filename.split('?')[0].split('#')[0];
            }
        }
    }
    document.addEventListener('alpine:init', () => {
        Alpine.data("pdfTemplate", pdfTemplateCtx)
    });
</script>